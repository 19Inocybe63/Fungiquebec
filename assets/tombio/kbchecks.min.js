!function(B,O){"use strict";O.checkKnowledgeBase=function(){if(void 0===O.opts.checkKB&&(O.opts.checkKB=O.kbconfig.checkValidity&&"yes"==O.kbconfig.checkValidity),!O.opts.checkKB)return!0;var s,l=!0,o=!0,t=!0,a=!0,e=!0,r=!0,i=O.characters.map(function(e){return e.Character}),n=Object.keys(O.taxa[0]).filter(function(e){return""!=e}),h=[];O.values.forEach(function(e){-1==h.indexOf(e.Character)&&h.push(e.Character)});var c=O.characters.filter(function(e){return"numeric"==e.ValueType&&-1<n.indexOf(e.Character)}).map(function(e){return e.Character}),u=O.characters.filter(function(e){return("ordinal"==e.ValueType||"ordinalCircular"==e.ValueType)&&-1<n.indexOf(e.Character)}).map(function(e){return e.Character}),p=O.characters.filter(function(e){return"ordinalCircular"==e.ValueType&&-1<n.indexOf(e.Character)}).map(function(e){return e.Character});function d(e,t){return!(!O.kbmetadata[e]||""==String(O.kbmetadata[e]).trim())||(r=!1,s.append(B('<li class="tombioValid3">').text(t)),!1)}B("#tombioReload").button({icons:{primary:"ui-icon-reset",secondary:null}}).click(function(e){window.location.reload(!0)}),B("#tombioContinue").button().css("margin-left","5px").click(function(e){B("#downloadspin").show(),B("#tombioKBReport").hide(),setTimeout(function(){O.loadComplete("force")},100)}),B("#tombioKBReport").append(B("<h3>").text("First fix these knowledge-base problems...")),B("#tombioKBReport").append(B("<p>").html("Some problems were found with the knowledge-base. They should be easy enough to fix. Read on for more details and guidance.")),B("#tombioKBReport").append(B("<p>").html("When you've fixed one or more problems, use the <i>Save worksheets as CSV</i> button on the KB to regenerate the CSVs and then click the <i>Reload</i> button above.")),B("#tombioKBReport").append(B("<p>").html("The problems are colour-coded according to the schema shown below:")),(s=B("<ul>")).append(B('<li class="tombioValid3">').html("These are serious problems that could cause the visualisation software to malfunction.")),s.append(B('<li class="tombioValid2">').html("These problems are not likely to cause the visualisation software to malfunction, but you might not see what you expect.")),s.append(B('<li class="tombioValid1">').html("These are for information only - it may be what you intended to do, but if not, you may as well sort them out. These will not cause the visualisation software to malfunction.")),B("#tombioKBReport").append(s),s=B("<ul>"),d("title","You must specify a title for the KB (Key - title). This is used to generate a citation.")||(r=!1),d("year","You must specify a year for the KB (Key - year). This is used to generate a citation.")||(r=!1),d("authors","You must specify one or more authors for the KB (Key - authors). This is used to generate a citation. Authors will appear in the citation exactly as you specify them.")||(r=!1),d("version","You must specify a version for the KB (Key - version). This is used to generate a citation.")||(r=!1),r||(B("#tombioKBReport").append(B("<h4>").text("On the config worksheet...")),B("#tombioKBReport").append(s)),s=B("<ul>"),O.taxa[0].Taxon||(s.append(B('<li class="tombioValid3">').html("There must be a column called <i>Taxon</i> (case sensitive) which stores the names of the taxa you are working with.")),l=!1);var m,f=/^[a-zA-Z0-9\-_]+$/;Object.keys(O.taxa[0]).forEach(function(e,t){f.test(e)||(s.append(B('<li class="tombioValid3">').html("<b>'"+e+"'</b> (column "+(t+1)+") is not a valid identifier for a character. Use only alphanumerics with no spaces.")),l=!1)});var b=/^(\d+(\.\d*)?|\.\d+)$/,y=/^\[(\d+(\.\d*)?|\.\d+)-(\d+(\.\d*)?|\.\d+)\]$/;c.forEach(function(t){O.taxa.forEach(function(e){(m=e[t])||""==m||console.log(e.Taxon,t,m),""==m||"n/a"==m||"?"==m||"#"==m.substr(0,1)||b.test(m)||y.test(m)||(s.append(B('<li class="tombioValid3">').html("The value <b>'"+m+"'</b> is not a valid for the numeric character <b>'"+t+"'</b> and taxon <b>'"+e.Taxon+"'</b>. Values must be a number or a range in the form '[x-y]'. (Other permitted values are '?', 'n/a' and no value.)")),l=!1)})});var v=/^\[[^-]+-[^-]+\]$/;u.forEach(function(n){O.taxa.forEach(function(r){if(""!=(m=r[n])&&"n/a"!=m&&"?"!=m&&"#"!=m.substr(0,1)){var i=O.values.filter(function(e){return e.Character==n});m.split("|").forEach(function(e){var a=!0;if(3<(e=e.trim()).length&&("(m)"==e.substr(e.length-3,3)||"(f)"==e.substr(e.length-3,3))&&(e=e.substr(0,e.length-3).trim()),v.test(e))var t=e.slice(1,-1).split("-").slice(0,2);else t=[e];if(t.forEach(function(t){t=t.trim(),0==i.filter(function(e){return e.CharacterState==t}).length&&(s.append(B('<li class="tombioValid2">').html("The value <b>'"+t+"'</b> for character <b>'"+n+"'</b> and taxon <b>'"+r.Taxon+"'</b> is not represented in the values worksheet. All character state values for ordinal and ordinalCircular characters must be represented on the values worksheet.")),a=l=!1)}),a&&2==t.length&&-1==p.indexOf(n)){var o=i.map(function(e){return e.CharacterState});o.indexOf(t[0])>o.indexOf(t[1])&&(s.append(B('<li class="tombioValid2">').html("The ordinal range <b>'"+e+"'</b> for character <b>'"+n+"'</b> and taxon <b>'"+r.Taxon+"'</b> is not valid since the start of the range appears after the end in the ordinal values expressed on the values worksheet for this character.")),l=!1)}})}})}),l||(B("#tombioKBReport").append(B("<h4>").text("On the taxa worksheet...")),B("#tombioKBReport").append(s)),s=B("<ul>");var x=O.characters.filter(function(e){return"Taxon"==e.Character});0<x.length&&"Taxonomy"!=x[0].Group&&(s.append(B('<li class="tombioValid3">').html("The Taxon character must have a Group value of 'Taxonomy'. It is currently set to '"+x[0].Group+"'.")),o=!1),n.forEach(function(e,t){-1==i.indexOf(e)&&(s.append(B('<li class="tombioValid3">').html("There is no row on the <i>characters</i> worksheet for the character <b>'"+e+"'</b> represented by a column (column "+(t+1)+") on the <i>taxa</i> worksheet. All columns on the <i>taxa</i> tab must be represented by a row in the <i>characters</i> worksheet regardless of whether or not they are used. Names are case sensitive. Note that rows will not be seen unless the <b>Group</b> column has a value.")),o=!1)}),i.forEach(function(e){-1==n.indexOf(e)&&(s.append(B('<li class="tombioValid2">').html("There is no column on the <i>taxa</i> worksheet for the character <b>'"+e+"'</b> which is represented in the <i>characters</i> worksheet.")),o=!1)}),O.characters.filter(function(e){return"key"==e.Status}).forEach(function(e){var t=!0,a=!0;/^([1-9]|10)$/.test(e.Weight)||(s.append(B('<li class="tombioValid3">').html("You must specify a 'Weight' value for <b>'"+e.Character+"'</b> because it has a 'Status' value of 'key'.")),o=!1);if("numeric"!=e.ValueType&&"ordinal"!=e.ValueType&&"ordinalCircular"!=e.ValueType||/^([0-9]|10)$/.test(e.Strictness)||(s.append(B('<li class="tombioValid3">').html("For numeric, ordinal and ordinalCircular characters, you must specify a 'Strictness' value of between 0 and 10. There is an invalid 'Strictness' value for <b>'"+e.Character+"'</b>.")),o=!1),-1==["numeric","ordinal","ordinalCircular","text"].indexOf(e.ValueType)&&(s.append(B('<li class="tombioValid3">').html("<b>'"+e.ValueType+"'</b>  is an invalid 'ValueType' value for <b>'"+e.Character+"'</b>. You must specify a valid 'ValueType' because it has a 'Status' value of 'key'.")),o=t=!1),-1==["single","multi","spin"].indexOf(e.ControlType)&&(s.append(B('<li class="tombioValid3">').html("<b>'"+e.ControlType+"'</b> is an invalid 'ControlType' value for <b>'"+e.Character+"'</b>. You must specify a valid 'ControlType' because it has a 'Status' value of 'key'.")),o=a=!1),t&&a&&-1=={numeric:["spin"],text:["single","multi"],ordinal:["single","multi"],ordinalCircular:["single","multi"]}[e.ValueType].indexOf(e.ControlType)&&(s.append(B('<li class="tombioValid3">').html("Invalid combination of 'ValueType' <b>('"+e.ValueType+"')</b> and 'ControlType' <b>('"+e.ControlType+"')</b> for <b>'"+e.Character+"'</b>. You must specify a valid combination because it has a 'Status' value of 'key'.")),o=!1),"spin"==e.ControlType){/^(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+),(\d+(\.\d*)?|\.\d+)$/.test(e.Params)||(s.append(B('<li class="tombioValid3">').html("<b>'"+e.Params+"'</b> is an invalid spin control 'Param' value for <b>'"+e.Character+"'</b>. It must have the form 'n,n,n' (where n can be any valid numeric value, including decimal).")),o=!1)}e.HelpShort&&!e.Help&&(s.append(B('<li class="tombioValid2">').html("A value for 'HelpShort' is set but there is no value for 'Help' for <b>'"+e.Character+"'</b>. You can set 'Help' without setting 'HelpShort', but not the other way around.")),o=!1)}),o||(B("#tombioKBReport").append(B("<h4>").text("On the characters worksheet...")),B("#tombioKBReport").append(s)),s=B("<ul>"),B("<ul>"),h.forEach(function(e){-1==i.indexOf(e)&&(s.append(B('<li class="tombioValid2">').html("There is no row on the <i>characters</i> worksheet for the character <b>'"+e+"'</b> represented in the <i>values</i> worksheet.")),t=!1)}),O.values.forEach(function(e){e.StateHelpShort&&!e.StateHelp&&(s.append(B('<li class="tombioValid2">').html("A value for 'StateHelpShort' is set but there is no value for 'StateHelp' for <b>'"+e.Character+" - "+e.CharacterState+"'</b>. You can set 'StateHelp' without setting 'StateHelpShort', but not the other way around.")),t=!1)}),t||(B("#tombioKBReport").append(B("<h4>").text("On the values worksheet...")),B("#tombioKBReport").append(s)),s=B("<ul>"),O.media.filter(function(e){return"image-local"==e.Type||"image-web"==e.Type}).forEach(function(t){if(""!=t.Character&&-1==i.indexOf(t.Character)?(s.append(B('<li class="tombioValid2">').html("An image is specified for the character <b>'"+t.Character+"'</b> on the media worksheet, but that character is not on the characters worksheet.")),a=!1):t.Character,""!=t.State&&""==t.Character&&(s.append(B('<li class="tombioValid2">').html("An image is specified for the state value <b>'"+t.State+"'</b> on the media worksheet, but no character is specified.")),a=!1),""!=t.State&&""!=t.Character){var e=O.values.filter(function(e){return t.Character==e.Character&&t.State==e.CharacterState});0!=e.length&&""!=e[0].StateHelp||(s.append(B('<li class="tombioValid2">').html("An image is specified for the character <b>'"+t.Character+"'</b> and state <b>'"+t.State+"'</b> on the media worksheet, but no corresponding pair is found with help text on the values worksheet, so it won't be displayed.")),a=!1)}}),a||(B("#tombioKBReport").append(B("<h4>").text("On the media worksheet...")),B("#tombioKBReport").append(s)),s=B("<ul>");var w=O.characters.filter(function(e){return"Taxonomy"==e.Group}),T=1<w.length?w[w.length-1].Character:null;if(T&&"Taxon"!=T&&(s.append(B('<li class="tombioValid3">').html("The last Taxonomy row representing '"+T+"' on the characters worksheet appears below the row representing 'Taxon' - it must come above.")),e=!1),"Taxon"==T&&2<w.length)for(var g=w.length-2;0<g;g--){var C=w[g].Character,k=w[g].Label,V=w[g-1].Character,S=w[g-1].Label,K=[];O.taxa.forEach(function(e){""!=e[C]&&-1==K.indexOf(e[C])&&K.push(e[C])}),K.forEach(function(t){var a=[];O.taxa.filter(function(e){return e[C]==t}).forEach(function(e){-1==a.indexOf(e[V])&&a.push(e[V])}),1<a.length&&(s.append(B('<li class="tombioValid3">').html("Taxa of "+k+" "+t+" are represented by more than one "+S+", breaking the rules of a strict hierarchical taxonomy. Check that the taxonomy columns are specified in the correct order on the characters worksheet  (at the moment "+S+" is specified at a higher level than "+k+"). If they are, then check the values for "+S+" and "+k+" on the taxa worksheet.")),e=!1)})}return e||(B("#tombioKBReport").append(B("<h4>").text("Taxonomy problems...")),B("#tombioKBReport").append(s)),!!(l&&o&&t&&a&&r&e)||(B("#tombioKBReport").show(),B("#downloadspin").hide(),!1)}}(jQuery,this.tombiovis);