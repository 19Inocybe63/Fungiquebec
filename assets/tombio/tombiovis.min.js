!function(D,M){"use strict";var H={xbullet:"&#x26AB ",bullet:"",delay:250,duration:1e3,infowidth:750,infoheight:700,helpAndInfoDialogWidth:550,helpAndInfoDialogHeight:400,visInfoDialogWidth:650,visInfoDialogHeight:350,scriptsLoaded:!1,htmlLoaded:!1,inputCharGroups:[],initialising:!0};function l(){var t,e=D("<div>");e.append(D("<h3>").text("Citation for general framework (core software)")),t="This is the reference you can use for the main Tom.bio Framework - in other words the core software.",t+=" The core version number is updated whenever there is a new major release of the core software.",e.append(D("<p>").html(t)),e.append(D("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),e.append(D("<span>").text("Copy citation")),e.append(D("<b>").html(M.getCitation(M.metadata,"Software"))),e.append(D("<h3>").text("Citation for last selected visualisation tool")),t="This is the reference you can use for the last selected visualisation tool.",t+=" The tool version number is updated whenever there is a new release of the tool.",t+=" If you cite a tool, there's no need to cite the core software separately since it is implicit.",e.append(D("<p>").html(t)),e.append(D("<input style='position: relative; top: 0.2em' type='checkbox' name='tbCitationVis' id='tbCitationVis'>")),e.append(D("<span>").text("Copy citation")),e.append(D("<b>").html(M.getCitation(H.lastVisualisation.metadata,"Software",M.metadata.title))),e.append(D("<h3>").text("Citation for knowledge-base")),t="This is the reference you can use for the knowledge-base currently driving the software.",t+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",e.append(D("<p>").html(t)),e.append(D("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),e.append(D("<span>").text("Copy citation")),e.append(D("<b>").html(M.getCitation(M.kbmetadata,"Knowledge-base",M.metadata.title)));var a=D("<button>Copy citations</button>").button();return a.on("click",function(){var t,e,a,i,n;D("#tbSelectedCitations").html(""),document.getElementById("tbCitationCore").checked&&D("#tbSelectedCitations").append(M.getCitation(M.metadata,"Software")),document.getElementById("tbCitationVis").checked&&D("#tbSelectedCitations").append(M.getCitation(H.lastVisualisation.metadata,"Software",M.metadata.title)),document.getElementById("tbCitationKb").checked&&D("#tbSelectedCitations").append(M.getCitation(M.kbmetadata,"Knowledge-base",M.metadata.title)),t=document.getElementById("tbSelectedCitations"),n=(e=e||window).document,e.getSelection&&n.createRange?(a=e.getSelection(),(i=n.createRange()).selectNodeContents(t),a.removeAllRanges(),a.addRange(i)):n.body.createTextRange&&((i=n.body.createTextRange()).moveToElementText(t),i.select()),D("#tbCitationInstructions").show()}),e.append(D("<p>").append(a).append("&nbsp;The selected citations will appear together below - just copy and paste")),e.append(D("<div id='tbSelectedCitations'>")),e.append(D("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),e}function r(){M.visChanged(D("#tombioVisualisation").val())}function i(t){var e=H.visualisations[t];if("tombioCitation"==t&&D("#tombioCitation").html(l()),"kbInfo"==t&&0==D("#kbInfo").html().length){var a=D("<h2>").text(M.kbmetadata.title);D("#kbInfo").html(a),D.get(M.opts.tombiokbpath+"info.html",function(t){D("#kbInfo").append(t.replace(/##tombiopath##/g,M.opts.tombiopath).replace(/##tombiokbpath##/g,M.opts.tombiokbpath))}).always(function(){var t=D("<h3>").attr("id","tombioKbCitation").text("Citation");D("#kbInfo").append(t),D("#kbInfo").append(M.getCitation(M.kbmetadata,"Knowledge-base",M.metadata.title));var e=D("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");D("#kbInfo").append(e);var a=D("<p>").html("<b>Current version: "+M.kbmetadata.version+"</b>");D("#kbInfo").append(a);var i=D("<table>"),n=D("<tr>").css("background-color","black").css("color","white");n.append(D("<td>").text("Date").css("padding","3px")),n.append(D("<td>").text("Version").css("padding","3px")),n.append(D("<td>").text("Notes").css("padding","3px")),i.append(n),M.kbreleaseHistory.forEach(function(t,e){n=D("<tr>"),e%2==0?n.css("background-color","rgb(200,200,200)"):n.css("background-color","rgb(230,230,230)");var a=new Date(t.Date);n.append(D("<td>").css("padding","3px").text(a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear())),n.append(D("<td>").css("padding","3px").text(t.Value)),n.append(D("<td>").css("padding","3px").text(t.Notes)),i.append(n)}),D("#kbInfo").append(i)})}if("visInfo"==t&&0==D("#visInfo").html().length&&D.get(M.opts.tombiopath+"visInfo.html",function(t){D("#visInfo").html(t.replace(/##tombiopath##/g,M.opts.tombiopath).replace(/##tombiokbpath##/g,M.opts.tombiokbpath))}),"currentVisInfo"==t){var n=new Array(H.lastVisualisation.helpFiles.length);H.lastVisualisation.helpFiles.forEach(function(t,i){D.get(t,function(t){var e,a;n[i]=t,e=!0,a="",n.forEach(function(t){t?a+=t:e=!1}),e&&(a=a.replace(/##tombiopath##/g,M.opts.tombiopath).replace(/##tombiokbpath##/g,M.opts.tombiokbpath),D("#currentVisInfo").html(a))})})}if(t!=H.currentTool&&(H.currentTool&&D("#"+H.currentTool).hide(),D("#"+t).show()),e&&e.charStateInput?c(!0):c(!1),e?D("#tombioControlsAndTaxa").show():D("#tombioControlsAndTaxa").hide(),A(),H.currentTool=t,-1<Object.keys(H.visualisations).indexOf(t)&&(H.lastVisualisation=H.visualisations[t],D("#optCurrentVisInfo").text("Using the "+H.lastVisualisation.metadata.title),D("#tombioVisualisation").iconselectmenu("refresh")),H.contextMenu.contextChanged(t),H.initialising&&H.visualisations[t]){for(var i={},o=decodeURI(window.location.search.substring(1)).split("&"),r=0;r<o.length;r++){var s=o[r].split("=");i[s[0]]=s[1]}H.visualisations[t].urlParams(i),H.initialising=!1}}function c(t){(null!=t?t:!D("#tombioControls").is(":visible"))?D("#tombioControls").show(0,s):(H.controlsWidth=D("#tombioControls").width(),D("#tombioControls").hide(0,s))}function A(){var d;d=D("#Sex").val(),M.taxa.forEach(function(h){h.scorefor=0,h.scoreagainst=0,h.scoreoverall=0,h.charcount=0,D(".statespinner").each(function(){var t=D(this).attr("id");if("clone-"!=t.substring(0,6)){var e,a,i,n;if(""==D(this).val())a=e=n=i=0;else if(""==h[t])a=e=n=i=0;else if("n/a"==h[t])n=i=1,a=e=0;else{var o=Number(D(this).val()),r=h[t].getRange(),s=Number(M.oCharacters[t].Strictness),l=M.oCharacters[t].maxVal-M.oCharacters[t].minVal,c=tombioScore.numberVsRange(o,r,l,s);e=c[0],a=c[1],i=1,n=0}h.matchscore[t].scorena=n,h.matchscore[t].scorefor=e,h.matchscore[t].scoreagainst=a,h.matchscore[t].scoreoverall=e-a-n;var p=Number(M.oCharacters[t].Weight)/10;h.scorefor+=e*p,h.scoreagainst+=a*p,h.scoreagainst+=n*p,h.scoreoverall+=(e-a-n)*p,h.charcount+=i}}),D(".stateselect").each(function(){var t=0,e=0,a=0,i=0,n=D(this).attr("id");if(void 0!==n&&"clone-"!=n.substring(0,6)&&null!=D(this).val()&&""!=D(this).val()){if("ordinal"==M.oCharacters[n].ValueType||"ordinalCircular"==M.oCharacters[n].ValueType){var o=Number(M.oCharacters[n].Strictness),r=(D(this).val(),[]);if("n/a"==h[n])i=a=1;else if("single"==M.oCharacters[n].ControlType?""!=D(this).val()&&r.push(D(this).val()):r=null==D(this).val()?[]:D(this).val(),0<r.length){var s=M.oCharacters[n].CharacterStateValues,l=h[n].getOrdinalRanges(d),c="ordinalCircular"==M.oCharacters[n].ValueType,p=tombioScore.ordinal2(r,l,s,o,c);t=p[0],e=p[1],i=1}}else{var r=[];if("n/a"==h[n])i=a=1;else if("single"==M.oCharacters[n].ControlType?""!=D(this).val()&&r.push(D(this).val()):r=null==D(this).val()?[]:D(this).val(),0<r.length){var l=h[n].getStates(d),p=tombioScore.character(r,l);t=p[0],e=p[1],i=1}}h.matchscore[n].scorena=a,h.matchscore[n].scorefor=t,h.matchscore[n].scoreagainst=e,h.matchscore[n].scoreoverall=t-e-a;var u=Number(M.oCharacters[n].Weight)/10;h.scoreagainst+=a*u,h.scorefor+=t*u,h.scoreagainst+=e*u,h.scoreoverall+=(t-e-a)*u,h.charcount+=i}})});var t=D("#tombioVisualisation").val();t in H.visualisations&&H.visualisations[t].refresh(),s()}function R(){var a=D("input[name=charvisibility]:checked").val();D(".cloneInput .stateselect, .cloneInput .statespinner").each(function(t){if(void 0!==D(this).attr("id"))if("visible"==a)D(this).parents(".cloneInput").show(500,s);else{var e=D(this).val();e&&""!=e?D(this).parents(".cloneInput").show(500,s):D(this).parents(".cloneInput").hide(500,s)}})}function s(){if(D("#tombioControls").is(":visible")){var t=D("#tombioControls").width();D("#tombioControlsAndTaxa").css("min-width",t+D("#tombioTaxa").width()+50)}else D("#tombioControlsAndTaxa").css("min-width","0px")}function N(n){var o=D("#"+n).pqSelect({multiplePlaceholder:"select option(s)",singlePlaceholder:"select option",checkbox:!0,search:!1,maxDisplay:20,width:240,selectallText:""});o.addClass("stateselect"),o.on("change",function(){if("clone-"==n.substring(0,6))var t=n.substring(6);else t="clone-"+n;if(D("#"+t).val(o.val()),D("#"+t).pqSelect("refreshData"),D("#"+n).pqSelect("refresh"),R(),"clone-"==n.substring(0,6))var a=n.substring(6);else a=n;var e=null!=o.val()&&""!=o.val();if(M.oCharacters[a].stateSet=e){var i=[];M.oCharacters[a].CharacterStateValues.forEach(function(t,e){-1<o.val().indexOf(t)&&i.push(e)}),M.oCharacters[a].userInput=i}[n,t].forEach(function(t){var e=D("#"+t).next().children().find(".pq-select-item-text");e.attr("title",function(){var e=this,t=M.values.filter(function(t){if(t.Character==a&&t.CharacterState==D(e).text())return!0});return 1==t.length?t[0].StateHelpShort?t[0].StateHelpShort:t[0].StateHelp:""}),e.tooltip({track:!0})}),A()}),o.val(D("#"+n+" option:first").val()).pqSelect("refreshData"),o.val("").pqSelect("refreshData")}function G(n,t,e,a){var o=D("#"+n).spinner({min:t,max:e,step:a});o.addClass("statespinner"),o.on("spinstop",function(t,e){if("clone-"==n.substring(0,6))var a=n.substring(6);else a="clone-"+n;if(D("#"+a).spinner("value",o.spinner("value")),"clone-"==n.substring(0,6))var i=n.substring(6);else i=n;M.oCharacters[i].stateSet=!0,M.oCharacters[i].userInput=o.spinner("value"),A(),R()}),D("#"+n+"-clear").button({icon:"ui-icon-close",showLabel:!1}).on("click",function(){if(o.spinner("value",""),"clone-"==n.substring(0,6))var t=n.substring(6);else t="clone-"+n;if(D("#"+t).spinner("value",o.spinner("value")),"clone-"==n.substring(0,6))var e=n.substring(6);else e=n;M.oCharacters[e].stateSet=!1,M.oCharacters[e].userInput=null,A()})}function p(t,e){return-1!==t.indexOf(e,t.length-e.length)}function O(e){return 0<M.oCharacters[e].Help.length||(0<M.values.filter(function(t){if(t.Character==e&&t.StateHelp)return!0}).length||0<M.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==e)return!0}).length)}M.loadComplete=function(t){D("#tombiod3-header").text(M.kbmetadata.title),D("#tombiod3-footer").html(M.getCitation(M.kbmetadata,"Knowledge-base",M.metadata.title)),(t||M.checkKnowledgeBase())&&(M.oTaxa={},M.taxa.forEach(function(t){for(var e in M.oTaxa[t.Taxon]=t)t.hasOwnProperty(e)&&(t[e]=new a(t[e]))}),M.characters.forEach(function(i){i.CharacterStates=[],i.CharacterStateValues=[],i.stateSet=!1,i.userInput=null,i.minVal=null,i.maxVal=null,"numeric"==i.ValueType&&M.taxa.forEach(function(t){var e=t[i.Character].getRange().min,a=t[i.Character].getRange().max;(!i.minVal||e<i.minVal)&&(i.minVal=e),(!i.maxVal||a>i.maxVal)&&(i.maxVal=a)})}),M.oCharacters={},M.characters.forEach(function(t){M.oCharacters[t.Character]=t}),M.media.forEach(function(t){"image-local"==t.Type&&(t.URI=M.opts.tombiokbpath+t.URI)}),M.taxa.forEach(function(e){M.characters.forEach(function(o){e[o.Character].valueType=o.ValueType,e[o.Character].status=o.Status,e[o.Character].character=o.Character;var r,t=e[o.Character].value.split("|");t.forEach(function(t,e){var a,i;p(t=t.trim(),"(m)")||p(t,"(f)")?(a=t.substr(0,t.length-4).trim(),i=t.substr(t.length-4,4)):(a=t,i="");var n=function(t,e){function a(e,a){var t=M.values.filter(function(t){return t.Character==e&&t.CharacterState.trim()==a});if(t[0]&&t[0].CharacterStateTranslation&&""!=t[0].CharacterStateTranslation)var i=t[0].CharacterStateTranslation;else var i=a;return i=i.replace(/ +(?= )/g,"")}if(/^\[[^-]+-[^-]+\]$/.test(e)){var i=e.substr(1,e.length-2),n=i.split("-");return"["+a(t,n[0])+"-"+a(t,n[1])+"]"}return a(t,e)}(o.Character,a);""!=i&&(n=n+" "+i),0<(r=r?r+" | "+n:n).length&&"#"==r.substr(0,1)&&(r="")}),e[o.Character].kbValue=r})}),M.values.forEach(function(t){var e=M.oCharacters[t.Character];if(e){if(t.CharacterStateTranslation&&""!=t.CharacterStateTranslation)var a=t.CharacterStateTranslation;else var a=t.CharacterState;e.CharacterStates.push({CharacterState:a,StateHelp:t.StateHelp}),e.CharacterStateValues.push(a)}}),M.characters.forEach(function(a){"key"==a.Status&&"text"==a.ValueType&&M.taxa.forEach(function(t){var e=t[a.Character].getStates("");e.forEach(function(t){""!=t&&-1==a.CharacterStateValues.indexOf(t)&&(a.CharacterStates.push({CharacterState:t,StateHelp:""}),a.CharacterStateValues.push(t))})})}),H.charactersGrouped=!1,M.characters.forEach(function(t){"key"==t.Status&&"none"!=t.Group.toLowerCase()&&(H.charactersGrouped=!0)}),function(){var e={All:[]};for(var t in M.characters.forEach(function(t){"key"==t.Status&&(e[t.Group]||(e[t.Group]=[],H.inputCharGroups.push(t.Group)),e[t.Group].push(t))}),e){var a="tombioControlTab-"+t.replace(/\s+/g,"-"),i=D("<li/>"),n=D("<a/>").text(t).attr("href","#"+a);i.append(n),D("#tombioControlsListElements").append(i);var o=D("<div/>").attr("id",a);if(D("#tombioControlTabs").append(o),"tombioControlTab-All"==a){o.append(D("<div>").text("Un-used characters:").css("font-weight","bold"));var r=D("<fieldset>").attr("id","visCheckboxes").css("display","inline-block").css("padding","0px").css("border","none");r.append(D("<label>").attr("for","charvisible").text("show")),r.append(D("<input>").attr("type","radio").attr("name","charvisibility").attr("id","charvisible").attr("value","visible").attr("checked","checked")),r.append(D("<label>").attr("for","incharvisible").text("hide")),r.append(D("<input>").attr("type","radio").attr("name","charvisibility").attr("id","incharvisible").attr("value","invisible")),o.append(r),D("[name='charvisibility']").checkboxradio({icon:!1}),r.on("change",R);var s=D("<button>").attr("id","tombioReset").text("Reset all");s.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(t){D(".statespinner").spinner("value",""),D(".stateselect").each(function(){D(this).val()&&D(this).val("").pqSelect("refreshData")}),M.characters.forEach(function(t){t.stateSet=!1,t.userInput=null}),A(),R()}),o.append(s)}for(var l=0;l<e[t].length;l++){var c=e[t][l],p=D("<span/>").attr("class","characterlabel").text(c.Label),u=D("<div/>").append(p);o.append(u),O(c.Character)&&(p.attr("character",c.Character),p.addClass("characterhelp"));var h=D("<div/>").attr("class","cloneInput");if(h.append(u.clone()),D("#tombioControlTab-All").append(h),"numeric"==c.ValueType){var d=c.Character,f=c.Params.split(","),m=Number(f[0]),b=Number(f[1]),v=Number(f[2]),g=D("<div></div>"),C=D("<input></input>").attr("class","spinner").attr("id",d),x=D("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id",d+"-clear");g.append(C),g.append(x),o.append(g),G(d,m,b,v);var y=D("<div></div>"),k=D("<input></input>").attr("class","spinner").attr("id","clone-"+d),w=D("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id","clone-"+d+"-clear");y.append(k),y.append(w),h.append(y),G("clone-"+d,m,b,v)}else{var S=c.Character;if("multi"==c.ControlType)var T=D("<select multiple=multiple></select>").attr("class","characterSelect");else var T=D("<select></select>").attr("class","characterSelect");if(T.attr("id",S),o.append(T),"single"==c.ControlType){var I=D("<option/>").text("");T.append(I)}var V=c.CharacterStateValues;V.forEach(function(t){var e=D("<option/>").text(H.bullet+t);T.append(e)}),N(S);var E=D("#"+S).clone();E.attr("id","clone-"+S),h.append(E),N("clone-"+S)}}}H.charactersGrouped||(D("#tombioControlsListElements").css("display","none"),D("#tombioControlTabs").css("padding-left","0px"));D(".characterhelp").hover(function(){D(this).animate({color:"#D55E00"},"fast")},function(){D(this).animate({color:"black"},"fast")}).tooltip({track:!0,items:"span",content:function(){return function(e){var a=D("<div/>"),t=!1;if(M.oCharacters[e].HelpShort&&""!=M.oCharacters[e].HelpShort){var i=M.oCharacters[e].HelpShort;t=!0}else var i=M.oCharacters[e].Help;var n,o,r=M.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==e)return!0}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)}),s=0,l=0;r.forEach(function(e){var a=!1,i=!1;e.UseFor?e.UseFor.split(",").forEach(function(t){"tip"==t.toLowerCase().trim()&&(i=!e.State),"full"==t.toLowerCase().trim()&&(a=!0)}):(i=!e.State,a=!0),i&&!n?n=e:a&&s++,a&&l++});var c=!1;if(n){(o=D("<figure/>")).addClass("helpFigure");var p=D("<img/>",{src:n.URI}).appendTo(o).css("margin-top",2);n.ImageWidth&&p.css("width",n.ImageWidth);D("<figcaption/>",{html:n.Caption}).appendTo(o);if(n.TipStyle&&""!=n.TipStyle){var u=n.TipStyle.split("-"),h=u[0],d=u[1];o.css("width",d+"%"),o.css("float",h),o.css("margin-bottom",5),"right"==h?o.css("margin-left",5):o.css("margin-right",5),c=!0}}var f=[];c&&f.push(o);0<i.length&&f.push(D("<span/>").html(i));!c&&o&&f.push(o);f.forEach(function(t){a.append(t)});var m=M.values.filter(function(t){if(t.Character==e&&t.StateHelp)return!0}),b="";if(t||0<s||0<m.length)var b="(Click for <b>more detailed help</b>.)";else if(n&&0<l)var b="(Click for resizeable help window.)";b&&D("<div/>").css("margin-top",5).css("font-weight","normal").html(b).appendTo(a);return a}(D(this).attr("character"))}}).click(function(){var r;r=D(this).attr("character"),D("#tombioHelpAndInfoDialog").html(""),D("<h3/>",{text:M.oCharacters[r].Label}).appendTo("#tombioHelpAndInfoDialog"),D("<p/>",{html:M.oCharacters[r].Help}).appendTo("#tombioHelpAndInfoDialog"),M.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==r&&!t.State){if(t.UseFor){var e=!1;return t.UseFor.split(",").forEach(function(t){"full"==t.toLowerCase().trim()&&(e=!0)}),e}return!0}}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)}).forEach(function(t,e){var a=D("<figure/>").appendTo("#tombioHelpAndInfoDialog");a.addClass("helpFigure");var i=D("<img/>",{src:t.URI}),n=D("<figcaption/>",{html:t.Caption});a.append(i).append(n),0<e&&i.css("margin-top",10),n.appendTo("#tombioHelpAndInfoDialog"),t.ImageWidth&&i.css("width",t.ImageWidth)}),M.values.filter(function(t){if(t.Character==r&&t.StateHelp)return!0}).forEach(function(e){if(e.CharacterStateTranslation&&""!=e.CharacterStateTranslation)var t=e.CharacterStateTranslation;else var t=e.CharacterState;var a=D("<p/>").appendTo("#tombioHelpAndInfoDialog"),i=D("<span/>",{text:t+": "}).css("font-weight","Bold");a.append(i);var n=D("<span/>",{html:e.StateHelp}).css("font-weight","Normal");a.append(n);var o=M.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==r&&t.State==e.CharacterState)return!0}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)});o.forEach(function(t,e){var a=D("<img/>",{src:t.URI}),i=D("<figcaption/>",{html:t.Caption});a.appendTo("#tombioHelpAndInfoDialog"),0<e&&a.css("margin-top",10),i.appendTo("#tombioHelpAndInfoDialog"),t.ImageWidth&&a.css("width",t.ImageWidth)})}),D("#tombioHelpAndInfoDialog").dialog("option","title","Character help and information"),D("#tombioHelpAndInfoDialog").dialog("open")})}(),D("#tombioMain").css("display",""),function(){H.contextMenu={},H.contextMenu.items={},H.contextMenu.contexts={},H.contextMenu.menu=D("<ul>").css("white-space","nowrap").appendTo("#tombioMain").addClass("contextMenu").css("position","absolute").css("display","none").css("z-index",999999),H.contextMenu.menu.menu(),D("#tombioMain").on("contextmenu",function(t){H.contextMenu.menu.position({});var e=D(this).parent().offset(),a=t.pageX-e.left,i=t.pageY-e.top;return H.contextMenu.menu.css({left:a,top:i}),H.contextMenu.menu.show(),!1}),D("#tombioMain").on("click",function(){H.contextMenu.menu.hide()}),H.contextMenu.addItem=function(t,e,a,i){if(i&&t in H.contextMenu.items&&(H.contextMenu.items[t].remove(),delete H.contextMenu.items[t],delete H.contextMenu.contexts[t]),!(t in H.contextMenu.items)){var n=D("<li>").append(D("<div>").text(t).click(e));H.contextMenu.menu.append(n),H.contextMenu.menu.menu("refresh"),H.contextMenu.items[t]=n,H.contextMenu.contexts[t]=a}},H.contextMenu.removeItem=function(t){t in H.contextMenu.items&&(H.contextMenu.items[t].remove(),delete H.contextMenu.items[t],delete H.contextMenu.contexts[t])},H.contextMenu.contextChanged=function(t){for(var e in H.contextMenu.items)-1<H.contextMenu.contexts[e].indexOf(t)?H.contextMenu.items[e].show():H.contextMenu.items[e].hide()},H.visualisations={};var e,i=[];i.push(D('<option value="reload" class="html" data-class="reload">Reload</option>')),M.includedTools.forEach(function(t,e){var a=D('<option class="needsclick">').attr("value",t).attr("data-class","vis").addClass("visualisation").text(M.jsFiles[t].toolName);i.push(a)}),i.push(D('<option id="optCurrentVisInfo" value="currentVisInfo" class="html" data-class="info"></option>')),i.push(D('<option value="kbInfo" class="html" data-class="info">About the Knowledge-base</option>')),i.push(D('<option value="visInfo" class="html" data-class="info">About Tom.bio ID Visualisations</option>')),i.push(D('<option value="tombioCitation" class="html" data-class="info">Get citation text</option>'));var t=function(t){for(var e=window.location.search.substring(1).split("&"),a=0;a<e.length;a++){var i=e[a].split("=");if(i[0]==t)return i[1]}return null}("selectedTool");t?e=t:M.opts.selectedTool?e=M.opts.selectedTool:M.kbconfig.selectedTool&&(e=M.kbconfig.selectedTool);var a=!1;i.forEach(function(t){t.attr("value")==e&&(t.attr("selected","selected"),a=!0)}),a||i[1].attr("selected","selected");D("#tombioVisualisation").append(i),D.widget("custom.iconselectmenu",D.ui.selectmenu,{_renderItem:function(t,e){var a=D("<li>"),i=D("<div>",{text:e.label});return e.disabled&&a.addClass("ui-state-disabled"),D("<span>",{style:e.element.attr("data-style"),class:"ui-icon "+e.element.attr("data-class")}).appendTo(i),a.append(i).appendTo(t)}}),D("#tombioVisualisation").iconselectmenu({change:function(){r()}}).iconselectmenu("menuWidget").addClass("ui-menu-icons customicons"),1==M.opts.hideVisDropdown&&D("#tombioVisualisation-button").hide();var n=D("#tombioControlTabs").tabs({activate:function(t,e){D(".stateselect").each(function(){}),s()}});void 0===M.opts.selectedGroup&&(M.opts.selectedGroup=M.kbconfig.defaultControlGroup?M.kbconfig.defaultControlGroup:null);if(M.opts.selectedGroup){var o=H.inputCharGroups.indexOf(M.opts.selectedGroup);-1<o&&n.tabs("option","active",o+1)}for(name in D("#tombioInfotoggle").button({icons:{primary:null,secondary:"ui-icon-info20"}}).click(function(t){D("#tombioInfoDialog").dialog("open")}),D("#tombioHelpAndInfoDialog").dialog({modal:!1,width:H.helpAndInfoDialogWidth,height:H.helpAndInfoDialogHeight,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}}),D("#tombioVisInfoDialog").dialog({modal:!1,width:H.visInfoDialogWidth,height:H.visInfoDialogHeight,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}}),D("#tombioOptions").button({icons:{primary:null,secondary:"ui-icon-options"},disabled:!1}).click(function(t){}),H.visWithInput=[],H.visualisations)H.visualisations[name].charStateInput&&H.visWithInput.push(name);H.contextMenu.addItem("Toggle key input visibility",function(){c()},H.visWithInput)}(),D("#downloadspin").remove(),M.taxa.forEach(function(e){e.matchscore={},M.characters.forEach(function(t){"key"==t.Status&&(e.matchscore[t.Character]={label:t.Label,scorena:0,scorefor:0,scoreagainst:0,scoreoverall:0})})}),s(),r(),M.loadCallback&&M.loadCallback())},M.initControlsFromParams=function(t){for(name in t)if(name.startsWith("c-")){var e=name.split("-")[1],a=M.characters[e];"spin"===a.ControlType?a.userInput=t[name]:a.userInput=t[name].split(","),a.stateSet=!0}M.characters.forEach(function(e,t){if(e.userInput)if("spin"===e.ControlType){var a=D("#"+e.Character+".statespinner"),i=D("#clone-"+e.Character+".statespinner");a.spinner("value",e.userInput),i.spinner("value",e.userInput)}else{a=D("#"+e.Character+".stateselect"),i=D("#clone-"+e.Character+".stateselect");var n=e.userInput.map(function(t){return e.CharacterStateValues[t]});a.val(n).pqSelect("refreshData"),i.val(n).pqSelect("refreshData")}}),D("#tombioControlTabs").tabs("option","active",t.grp),D("[name='charvisibility']").removeProp("checked").filter('[value="'+t.cvis+'"]').prop("checked",!0),D("[name='charvisibility']").checkboxradio("refresh"),R(),A()},M.setParamsFromControls=function(){var i=[];return M.characters.forEach(function(t,e){if(t.userInput){var a="c-"+e;"spin"===t.ControlType?i.push(a+"="+t.userInput):i.push(a+"="+t.userInput.join(","))}}),i.push("grp="+D("#tombioControlTabs").tabs("option","active")),i.push("cvis="+D("input[name=charvisibility]:checked").val()),i},M.getCitation=function(t,e,a){var i,n=D("<div class='tombioCitation'>"),o=new Date;return i=t.authors+" ",i+="("+t.year+") ",i+="<i>"+t.title+"</i>",i+=" (Version "+t.version+") ["+e+"]",a&&(i+=" (for "+a+")"),i+=". ",t.publisher&&(i+=t.publisher+". "),t.location&&(i+=t.location+". "),i+="Accessed "+o.toDateString()+". ",i+=window.location.href.split("?")[0],n.append(D("<div>").html(i)),n},M.visChanged=function(e,t){if("reload"!=e)if("visInfo"!=e&&"kbInfo"!=e){var a;if("tombioCitation"==e||"currentVisInfo"==e)return a=t||(H.lastVisualisation?H.lastVisualisation.visName:M.opts.lastVisualisation?M.opts.lastVisualisation:"vis1"),M.showDownloadSpinner(),M.jsFiles[a]&&M.jsFiles[a].loadReady(),void M.loadScripts(function(){if(M.hideDownloadSpinner(),!H.visualisations[a]){var t=new M[a].Obj("#tombioTaxa",H.contextMenu,M);H.visualisations[a]=t}H.lastVisualisation=H.visualisations[a],i(e)});D("#tombioVisualisation").val()!=e&&D("#tombioVisualisation").val(e),M.showDownloadSpinner(),M.jsFiles[e]&&M.jsFiles[e].loadReady(),M.loadScripts(function(){if(M.hideDownloadSpinner(),!H.visualisations[e]){var t=new M[e].Obj("#tombioTaxa",H.contextMenu,M);H.visualisations[e]=t}console.log("Starting",e),i(e)})}else i(e);else D.ajax({url:window.location.href,headers:{Pragma:"no-cache",Expires:-1,"Cache-Control":"no-cache"}}).done(function(){window.location.reload(!0)})};var a=function(t){this.kbValue=t.trim(),this.valueType=null,this.status=null,this.character=null};Object.defineProperty(a.prototype,"value",{get:function(){return"?"==this.kbValue.trim()?"":this.kbValue.trim()}}),a.prototype.toString=function(){return"?"==this.kbValue?"":this.kbValue},a.prototype.getStates=function(t){t||(t="");for(var e=[],a=this.kbValue.split("|"),i=0;i<a.length;i++){var n=a[i];"n/a"!=(n=n.trim())&&"?"!=n&&""!=n&&("male"!=t||p(n,"(f)")?"female"!=t||p(n,"(m)")?""==t&&e.push(n.replace("(m)","").replace("(f)","").trim()):e.push(n.replace("(f)","").trim()):e.push(n.replace("(m)","").trim()))}return e},a.prototype.getRange=function(){var t={};if(""==String(this.kbValue)?t.hasValue=!1:t.hasValue=!0,0==String(this.kbValue).indexOf("[")){var e=this.kbValue.substr(1,this.kbValue.length-2).split("-");t.min=Number(e[0]),t.max=Number(e[1]),t.mid=t.min+(t.max-t.min)/2}else t.min=Number(this.kbValue),t.max=Number(this.kbValue),t.mid=Number(this.kbValue);return t},a.prototype.getOrdinalRanges=function(t){var r=this,s=[];return"ordinal"!=this.valueType&&"ordinalCircular"!=this.valueType||this.getStates(t).forEach(function(t){var e=[];if(0==t.indexOf("[")){var a=t.substr(1,t.length-2).split("-"),i=a[0],n=a[1],o=!1;M.oCharacters[r.character].CharacterStateValues.forEach(function(t){t==i&&(o=!0),o&&e.push(t),t==n&&(o=!1)}),o&&M.oCharacters[r.character].CharacterStateValues.forEach(function(t){o&&e.push(t),t==n&&(o=!1)})}else e.push(t);s.push(e)}),s},a.prototype.toHtml1=function(){if("n/a"==this.kbValue)return"<i>not applicable</i>";if(""==this.kbValue||"?"==this.kbValue)return"<i>no value specified</i>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType)return e=(e=(e=(e=(e=(e=this.kbValue.replace(/([^|]+)/g,"<b>$1</b>")).replace(/(\(m\)\s*<\/b>)/g,"</b> (male)")).replace(/(\(f\)\s*<\/b>)/g,"</b> (female)")).replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>")).replace(/\s*\|\s*/g," or "),"display"==this.status&&(e=e.replace(/<b>/g,"").replace(/<\/b>/g,"")),e;if("numeric"==this.valueType){var t=this.getRange();if(0==t.hasValue)var e="<b>no value in knowledge-base</b>";else if(t.min==t.max)e="<b>"+t.min+"</b>";else e="<b>"+t.min+"-"+t.max+"</b> (range)";return"display"==this.status&&(e=e.replace(/<b>/g,"").replace(/<\/b>/g,"")),e}return this.kbValue},a.prototype.toHtml2=function(){if("n/a"==this.kbValue)return"<li><i>not applicable</i></li>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalCircular"==this.valueType){for(var t="",e=this.kbValue.split("|"),a=0;a<e.length;a++){var i=e[a].trim();i=(i=(i=/\(m\)$/.test(i)?"<b>"+i.replace(/\(m\)$/,"</b> (male)"):/\(f\)$/.test(i)?"<b>"+i.replace(/\(f\)$/,"</b> (female)"):"<b>"+i.trim()+"</b>").replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>"),a<e.length-1&&(i+=" or"),t+="<li>",t+=i,t+="</li>"}return t}if("numeric"==this.valueType){var n=this.getRange();return 0==n.hasValue?"<li><i>no value in knowledge-base</i></li>":n.min==n.max?"<li><b>"+n.min+"</b></li>":"<li><b>"+n.min+" - "+n.max+"</b> (range)</li>"}return this.kbValue}}(jQuery,this.tombiovis);