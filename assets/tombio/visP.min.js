!function(D,j){"use strict";var t=j.visP={};t.Obj=function(t,e,o,i){this.visName=t,this.contextMenu=o,this.taxa=i.taxa,this.oTaxa=i.oTaxa,this.characters=i.characters,this.oCharacters=i.oCharacters,this.media=i.media,this.div=D("<div/>").attr("id",t).css("display","none").appendTo(e),this.cssSel=e+" > #"+t,this.mobile=/Mobi/.test(navigator.userAgent);var s=this;this.charactersGrouped=!1,this.characters.forEach(function(t){"key"==t.Status&&"none"!=t.Group.toLowerCase()&&(s.charactersGrouped=!0)}),this.metadata={title:null,year:null,authors:null,publisher:null,location:null,contact:null,version:null},this.initialise()},t.Obj.prototype.fireRefresh=function(){"function"==typeof this.onRefresh&&setTimeout(this.onRefresh,1)},t.Obj.prototype.initialise=function(){this.charStateInput=!1,this.div.append("<h2>"+this.visName+"</h2>"),this.div.append("<p>Selector is: "+this.cssSel+"</p>")},t.Obj.prototype.urlParams=function(){},t.Obj.prototype.fullDetails=function(t,e,o,i){var s=this;o=void 0!==o?o:0,i=void 0!==i?i:0,e=void 0!==e?e:1;var a=D("<div>").addClass("tombioFullDetailsTabs");a.css("border","none");var r=D("<ul>").appendTo(a);r.append("<li><a href='#tabs-1'>Knowledge-base</a></li>"),r.append("<li><a href='#tabs-2'>Images</a></li>"),r.append("<li><a href='#tabs-3'>Details</a></li>");var n=D("<div>").attr("id","tabs-1").appendTo(a),c=D("<div>").attr("id","tabs-2").appendTo(a),l=D("<div>").attr("id","tabs-3").appendTo(a),p=D("<div>").append(a);p.addClass("tombioFullDetailsDlg"),p.attr("title",t),p.dialog({height:550,width:600,modal:!0,resizeStop:function(t,e){c.find(".baseimage").trigger("change")}}),a.tabs({active:e,activate:function(t,e){c.find(".baseimage").trigger("change");var o=l.find("#tombioFullDetailsHTMLDiv");s.resizeIframe(o)}}),l.css("overflow","hidden");var h=this.showTaxonCharacterValues(j.oTaxa[t],!0);n.append(h);var d=this.getTaxonImagesDiv(t,c,0,!0,!0);c.append(d),this.getHTMLFileSelectionDiv(t,l)},t.Obj.prototype.fullDetailsTest=function(t,e,o,i){var s=D("<div>").dialog();s.dialog({height:400,width:300});var a=D("<div>"),r=D("<select></select>").appendTo(a),n=D("<option/>").text("one");r.append(n);n=D("<option/>").text("two");r.append(n),s.append(a),r.selectmenu()},t.Obj.prototype.refresh=function(){this.div.append("<p>Refresh fired "+Date()+"</p>"),this.fireRefresh()},t.Obj.prototype.sortTaxa=function(t,o){return t.sort(function(t,e){return t.scoreoverall>e.scoreoverall?-1:e.scoreoverall>t.scoreoverall?1:e.scoreoverall==t.scoreoverall?t.scorefor>e.scorefor?1:e.scorefor>t.scorefor?-1:null==o?1:t[o]>e[o]?1:-1:void 0})},t.Obj.prototype.getTaxonImagesDiv=function(t,s,i,a,e){var r,n,c,l,p=this.getTaxonImages(t),h=this;if(i>=p.length&&(i=0),0==p.length){var o=D("<div>").css("margin","10px");return o.text("No images are specified in the knowledge-base for this taxon."),o}function d(e,o){g.attr("indexSelected",e);var i=p[e];H.find("img").attr("src",j.opts.tombiopath+"resources/camera.png"),"0px"!=g.css("width")&&(console.log("resizing pane"),g.css("width",g.css("width")),g.css("height",g.css("height"))),f.attr("src",null),w.html("");var t=new Image;t.onerror=function(){w.html("Couldn't load image'"+i.URI+"'.")},t.onload=function(){w.html(i.Caption),f.attr("src",this.src),w.html(i.Caption),s?(a||(s.css("width",f.width()+10),s.css("height",f.height()+10+30)),g.css("height","100%"),g.css("width","100%")):(g.css("width",f.width()+10),g.css("height",f.height()+10+30)),f.css("opacity",.2),g.find("#imgLink"+e).attr("src",j.opts.tombiopath+"resources/cameragreen.png");var t=this;setTimeout(function(){b.attr("src",t.src).css("width",f.width()).css("height",f.height()).css("left",0).css("top",0).attr("viewWidth",f.width()).attr("viewHeight",f.height()).attr("xProp",.5).attr("yProp",.5)},50),o&&o()},t.src=i.URI}function u(t,e,o,i,s,a,r){var n,c,l,p,h,d,u=Number(t.attr("viewWidth")),g=Number(t.attr("viewHeight")),m=Number(t.css("width").replace("px","")),f=Number(t.css("height").replace("px","")),b=Number(t.attr("xProp")),v=Number(t.attr("yProp"));e?(d=o,m<(h=e)&&(i=e,s=o),a=b*m,r=v*f):(h=u,d=g),i?(i<h?(n=h,c=d):(n=i,c=s),a=b*n,r=v*c):(n=m,c=f),a?(l=0<=a-h/2&&a+h/2<=n?a:a-h/2<0?h/2:n-h/2,p=0<=r-g/2&&r+g/2<=c?r:r-g/2<0?g/2:0==g?c/2:c-g/2):(l=b*m,p=v*f),t.css("height",c).css("max-width",n).css("width",n).css("left",0-(l-h/2)).css("top",0-(p-d/2)).attr("viewWidth",h).attr("viewHeight",d).attr("xProp",l/n).attr("yProp",p/c),Math.round(n)>Math.round(h)?(t.draggable("enable"),t.css("cursor","-webkit-grab")):(t.draggable("disable"),t.css("cursor","inherit"))}null==i&&(i=0);var g=D("<div/>").attr("class","tombioImage").css("border","").css("position","relative").css("border-radius",10).css("background-color","grey").css("overflow","hidden"),m=D("<div/>").css("line-height",0).css("margin",5).css("border-radius",7).css("position","relative").css("overflow","hidden").css("background-color","grey").css("background-image","url('"+j.opts.tombiopath+"resources/loading.gif')").css("background-repeat","no-repeat").css("background-position","center"),f=D("<img/>").css("width","100%").attr("class","baseimage").change(function(){u(f.siblings(".zoomimage"),f.width(),f.height(),null,null,null,null)}),b=D("<img/>").attr("class","zoomimage").css("position","absolute").css("left",0).css("top",0).draggable({start:function(){r=Number(b.css("left").replace("px","")),n=Number(b.css("top").replace("px","")),c=Number(b.css("width").replace("px",""))*b.attr("xProp"),l=Number(b.css("height").replace("px",""))*b.attr("yProp")},drag:function(t,e){0<e.position.left&&(e.position.left=0),0<e.position.top&&(e.position.top=0),Number(b.css("width").replace("px",""))+e.position.left<Number(b.attr("viewWidth"))&&(e.position.left=Number(b.attr("viewWidth"))-Number(b.css("width").replace("px",""))),Number(b.css("height").replace("px",""))+e.position.top<Number(b.attr("viewHeight"))&&(e.position.top=Number(b.attr("viewHeight"))-Number(b.css("height").replace("px","")));var o=r-e.position.left,i=n-e.position.top;Number(b.css("width").replace("px","")),b.attr("xProp");u(b,null,null,null,null,c+o,l+i)}});b.draggable("disable");var v=D("<div>").css("position","absolute").css("left",0).css("top",0).css("height","100%").css("width","30px").css("background","rgba(0,0,0,0.3)").css("cursor","pointer").css("opacity",0).hover(function(){h.mobile||(T.stop().fadeTo(400,1),v.stop().fadeTo(400,1))},function(){h.mobile||(T.stop().fadeTo(400,0),v.stop().fadeTo(400,0))}).click(function(){if(0!=D(this).css("opacity")){var t=Number(g.attr("indexSelected"));d((p.length+t-1)%p.length,function(){h.mobile||(T.stop().fadeTo(400,1),v.stop().fadeTo(400,1),C.stop().fadeIn(10).fadeOut(800))})}}),x=D('<img src="'+j.opts.tombiopath+'resources/moveleft.png">').css("position","absolute").css("top","50%").css("left",0).css("transform","translate(0, -50%)").css("opacity",1);v.append(x);var T=D("<div>");T.css("position","absolute").css("right",0).css("top",0).css("height","100%").css("width","30px").css("background","rgba(0,0,0,0.3)").css("cursor","pointer").css("opacity",0).hover(function(){h.mobile||(T.stop().fadeTo(400,1),v.stop().fadeTo(400,1))},function(){h.mobile||(T.stop().fadeTo(400,0),v.stop().fadeTo(400,0))}).click(function(){if(0!=D(this).css("opacity")){var t=Number(g.attr("indexSelected"));d((p.length+t+1)%p.length,function(){h.mobile||(T.stop().fadeTo(400,1),v.stop().fadeTo(400,1),C.stop().fadeIn(10).fadeOut(800))})}});var y=D('<img src="'+j.opts.tombiopath+'resources/moveright.png">').css("position","absolute").css("top","50%").css("right",0).css("transform","translate(0, -50%)").css("opacity",1);T.append(y);var w=D("<div/>").css("margin",5).attr("class","taxonImageCaption");if(m.append(f),m.append(b),m.append(v),m.append(T),g.append(m),g.append(w),g.attr("indexSelected",i),b.mousewheel(function(t){t.stopPropagation();var e=Number(b.css("width").replace("px","")),o=Number(b.css("height").replace("px",""));if(0<t.deltaY)var i=1.1*e,s=1.1*o;else i=e/1.1,s=o/1.1;return u(b,null,null,i,s,null,null),!1}),h.mobile){console.log("this is mobile!");var I=new Hammer(b.get(0));I.get("pinch").set({enable:!0}),I.on("pinchstart",function(t){h.initPinchWidth=Number(b.css("width").replace("px","")),h.initPinchHeight=Number(b.css("height").replace("px",""))}),I.on("pinch",function(t){var e=h.initPinchWidth*t.scale,o=h.initPinchHeight*t.scale;u(b,null,null,e,o,null,null)})}var C=D("<div/>").css("margin-right",30).css("margin-top",6).css("margin-left",6).css("display","none"),N=D("<div/>").css("position","absolute").css("top",0).css("left",0).css("width","100%").css("height",30).hover(function(){h.mobile||C.stop().fadeIn(400)},function(){h.mobile||C.stop().fadeOut(400)});h.mobile&&I.on("press",function(t){h.imageControlsDisplayed?(C.stop().fadeOut(400),T.stop().fadeTo(400,0),v.stop().fadeTo(400,0)):(C.stop().fadeIn(400),T.stop().fadeTo(400,1),v.stop().fadeTo(400,1)),h.imageControlsDisplayed=!h.imageControlsDisplayed});var O,H=D("<div/>");if(C.append(H),p.forEach(function(t,e){var o=D("<img/>");i==e?(O=j.opts.tombiopath+"resources/cameragreen.png",o):O=j.opts.tombiopath+"resources/camera.png",o.attr("src",O).css("cursor","pointer").css("width",20).css("margin",2).attr("id","imgLink"+e).click("click",function(){d(e)}),o.tooltip({items:"img",content:function(){return t.Caption}}),H.append(o)}),!e){var k=D("<img/>");k.attr("src",j.opts.tombiopath+"resources/remove.png").css("cursor","pointer").css("position","absolute").css("top",8).css("right",8).css("width",20).click("click",function(){g.addClass("userRemoved"),s?s.remove():g.remove()}),C.append(k)}return N.append(C),g.append(N),d(i),g.selectByIndex=function(t){console.log("Select image",t)},g},t.Obj.prototype.getTaxonImages=function(e){return this.media.filter(function(t){if(t.Taxon==e&&("image-local"==t.Type||"image-web"==t.Type))return!0}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)})},t.Obj.prototype.getTaxonTipImage=function(o){var t=this.media.filter(function(t){if(t.Taxon==o&&("image-local"==t.Type||"image-web"==t.Type)){if(t.UseFor){var e=!1;return t.UseFor.split(",").forEach(function(t){"tip"==t.toLowerCase().trim()&&(e=!0)}),e}return!0}}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)});if(0<t.length){var e=D("<div/>"),i=t[0],s=D("<img/>",{src:i.URI}).appendTo(e).css("margin-top",2);D("<figcaption/>",{html:i.Caption}).appendTo(e);return i.ImageWidth&&s.css("width",i.ImageWidth),e}return null},t.Obj.prototype.getTaxonHtmlFiles=function(e){return this.media.filter(function(t){if(t.Taxon==e&&"html-local"==t.Type)return!0}).sort(function(t,e){return Number(t.Priority)-Number(e.Priority)})},t.Obj.prototype.showFloatingImages=function(t,e,o){var i=this,s=D("<div/>").appendTo("#tombioMain");s.attr("class","tombioFloatingImage").css("position","absolute").css("top",o).css("left",e).css("width",350).css("background-color","grey").css("border-radius",10).css("cursor","move").css("z-index",function(){var e=5e3;return D(".tombioFloatingImage").each(function(){var t=Number(D(this).css("z-index"));e<t&&(e=t)}),e+1}).draggable().resizable({resize:function(){s.find(".baseimage").trigger("change")}}).click(function(){var e=5e3;D(".tombioFloatingImage").each(function(){var t=Number(D(this).css("z-index"));e<t&&(e=t)}),D(this).css("z-index",e+1)}),s.append(this.getTaxonImagesDiv(t,s)),this.contextMenu.addItem("Close all images",function(){D(".tombioFloatingImage").remove(),i.contextMenu.removeItem("Close all images")},[this.visName])},t.Obj.prototype.showCharacterScoreDetails=function(t,e){var o;o="<p>Specified state(s) for character <b>"+e.Label+"</b>: </p>";var i=D("#"+e.Character);o+="<ul>","spin"==e.ControlType||"single"==e.ControlType?(o+="<li><b>",o+=i.val(),o+="</b></li>"):"multi"==e.ControlType&&i.val().forEach(function(t){o+="<li><b>",o+=t,o+="</b></li>"}),o+="</ul>",o+="<p>Valid state(s) for <b>"+e.Label+"</b> recorded against ",o+="<b><i>"+t.Taxon+"</i></b> in the knowledge base: ",o+="<ul>",o+=t[e.Character].toHtml2(),o+="</ul>",o+="<hr/>",o+="<p>Knowledge-base <b>weighting</b> for this character: <b>"+e.Weight+"</b></p>",o+="<p>Knowledge-base <b>strictness</b> for this character: <b>"+e.Strictness+"</b></p>",o+="<hr/>",o+="<p>Unweighted character score: <b>"+Math.round(100*t.matchscore[e.Character].scoreoverall)/100+"</b>; ",o+="(for, "+Math.round(100*t.matchscore[e.Character].scorefor)/100,o+="; against, "+Math.round(100*(t.matchscore[e.Character].scoreagainst+t.matchscore[e.Character].scorena))/100+")</p>",o+="<p>Weighted character score: <b>"+Math.round(t.matchscore[e.Character].scoreoverall*e.Weight*10)/100+"</b></p>",D("#tombioHelpAndInfoDialog").dialog("option","title","Character score details"),D("#tombioHelpAndInfoDialog").html(o),D("#tombioHelpAndInfoDialog").dialog("open")},t.Obj.prototype.showTaxonCharacterValues=function(a,t){var r=D("<table>");r.css("width","100%"),r.css("margin","0px");var n=0,c="",l=this;if(this.characters.forEach(function(t){if("key"==t.Status||"display"==t.Status){if(l.charactersGrouped&&t.Group!=c){(o=D("<tr>")).css("background-color","rgb(100,100,100)"),o.css("color","rgb(255,255,255)");var e=D("<td colspan='3'>");o.append(e.append(t.Group)),r.append(o),c=t.Group}n++;var o=D("<tr>");n%2!=0?o.css("background-color","rgb(200,200,200)"):o.css("background-color","rgb(230,230,230)");var i=D("<td>").append(t.Label),s=D("<td>").append(a[t.Character].toHtml1());o.append(i),o.append(s),r.append(o)}}),r.find("td").css("padding","2"),t)return r;D("#tombioHelpAndInfoDialog").dialog("option","title",a.Taxon),D("#tombioHelpAndInfoDialog").html(r),D("#tombioHelpAndInfoDialog").dialog("open")},t.Obj.prototype.getHTMLFileSelectionDiv=function(o,t){var e=D("<div>").appendTo(t),i=this,s=this.getTaxonHtmlFiles(o);if(0==s.length){D("<div>").css("margin","10px").appendTo(e).text("No text information files (HTML) are specified in the knowledge-base for this taxon.")}else{var a=D('<iframe id="tombioFullDetailsHTMLDiv" scrolling="no" width="100%" frameborder="0">');if(1<s.length){var r=D('<div style="margin-bottom: 20px">').appendTo(e),n=D("<select id='tombioFileSelect'></select>").appendTo(r);s.forEach(function(t,e){var o=D("<option/>").text(t.Caption).attr("value",e);n.append(o)}),n.selectmenu({change:function(t,e){i.showTaxonHtmlIframe(o,a,e.item.value)}})}a.on("load",function(){i.resizeIframe(D(this))}),a.appendTo(e),this.showTaxonHtmlIframe(o,a,0)}},t.Obj.prototype.resizeIframe=function(t){t.height(10),t.height(t.contents().height()+100)},t.Obj.prototype.showTaxonHtmlIframe=function(t,e,o){var i=this.getTaxonHtmlFiles(t);o<=i.length-1?e.attr("src",j.opts.tombiokbpath+i[o].URI+"?ver="+j.opts.tombiover):e.attr("src",null)},t.Obj.prototype.showTaxonHtmlInfo=function(t,a,e){var o=this.getTaxonHtmlFiles(t);e<=o.length-1?D.get(j.opts.tombiokbpath+o[e].URI+"?ver="+j.opts.tombiover,function(t){var e=t.indexOf("<body"),o=t.indexOf("</body"),i=t.slice(e,o),s=D("<div>").html(i);a.html(s.html())}):a.html(null)},t.Obj.prototype.shortName=function(t){var e=t.split(" "),o="";return e.forEach(function(t,e){0==e?o+=t.substring(0,1):(o+=" ",o+=t.substring(0,3))}),o},t.Obj.prototype.taxonTag=function(t){return t.replace(/[|&;$%@"<>()+:.,'\/ ]/g,"")},t.Obj.prototype.copyTextToClipboard=function(t){var e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select();try{var o=document.execCommand("copy")?"successful":"unsuccessful";console.log("Copying text "+o)}catch(t){console.log("Oops, unable to copy text")}document.body.removeChild(e)},t.Obj.prototype.scoreColours=["#fc8d59","#ffffbf","#91bfdb"]}(jQuery,this.tombiovis);